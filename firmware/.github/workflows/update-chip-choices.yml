name: Update Chip Choices

on:
  # Run on a schedule (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering
  workflow_dispatch:
  # Also run when the workflow file changes
  push:
    paths:
      - '.github/workflows/update-chip-choices.yml'
      - 'scripts/update-chip-choices.py'

jobs:
  update-chips:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update chip choices
        id: update
        run: |
          python3 scripts/update-chip-choices.py
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: git-check
        run: |
          if [ -n "$(git status --porcelain cargo-generate.toml pre-script.rhai)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Chip choices and configurations have been updated"
            git diff cargo-generate.toml pre-script.rhai
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to chip choices or configurations"
          fi

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add cargo-generate.toml pre-script.rhai
          git commit -m "chore: auto-update chip choices and configurations from stm32-data-generated

          This commit was automatically generated by the update-chip-choices workflow.
          It updates:
          - Available chip choices in cargo-generate.toml
          - Target configurations in pre-script.rhai

          Data sourced from embassy-rs/stm32-data-generated."
          git push

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-update chip choices and configurations from stm32-data-generated"
          title: "chore: Auto-update chip choices and configurations from stm32-data-generated"
          body: |
            This PR was automatically created by the update-chip-choices workflow.

            It updates the available chip choices and configurations based on the
            latest data from [embassy-rs/stm32-data-generated](https://github.com/embassy-rs/stm32-data-generated).

            ## Changes
            - Updated chip choices list in `cargo-generate.toml`
            - Updated STM32 configurations in `pre-script.rhai` (flash/RAM layout, Rust targets)
            - Added new STM32 chips from stm32-data-generated
            - Preserved existing non-STM32 chips (nrf, rp, esp)

            ## What's Updated
            The script fetches metadata for 20 representative STM32 chips from different families and generates
            their configurations (memory layout, Rust target triple, probe chip name). Other STM32 chips use
            intelligent family-based defaults.

            ## Review
            Please review the changes and merge if they look correct.
          branch: auto-update-chip-choices
          delete-branch: true
